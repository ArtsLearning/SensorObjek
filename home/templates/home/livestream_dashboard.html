{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Livestream Dashboard{% endblock %}

{% block content %}
<div class="space-y-10">

    <!-- Judul -->
    <h1 class="text-3xl font-bold mb-6">Halaman Livestream</h1>

    <!-- =============================== -->
    <!-- LIVE STREAM VIDEO SECTION -->
    <!-- =============================== -->
    <div class="bg-white shadow rounded-xl p-6">
        <h2 class="font-semibold text-gray-700 mb-4">Live Streaming</h2>

        <!-- Responsive Video Wrapper -->
        <div class="relative w-full pb-[56.25%] rounded-xl overflow-hidden shadow bg-black">
            <iframe
                id="webrtc-frame"
                src="http://127.0.0.1:8889/traffic?video=webrtc"
                class="absolute top-0 left-0 w-full h-full"
                frameborder="0"
                allow="autoplay; fullscreen">
            </iframe>
        </div>

        <p id="livestream-status" class="text-red-600 font-semibold text-center mt-3">
            ⚠ LIVE STREAMING SEDANG TIDAK TERSEDIA
        </p>
    </div>

    <!-- =============================== -->
    <!-- REALTIME CHART -->
    <!-- =============================== -->
    <div class="bg-white shadow rounded-xl p-6">
        <h2 class="font-semibold text-gray-700 mb-4">Volume Kendaraan (Realtime)</h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 place-items-center">
            <div class="flex flex-col items-center justify-center">
                <canvas id="motorChart" class="w-28 h-28" style="max-height:120px;"></canvas>
                <p class="mt-2 font-semibold">Motor: <span id="motor-count">0</span></p>
            </div>
            <div class="flex flex-col items-center justify-center">
                <canvas id="mobilChart" class="w-28 h-28" style="max-height:120px;"></canvas>
                <p class="mt-2 font-semibold">Mobil: <span id="mobil-count">0</span></p>
            </div>
            <div class="flex flex-col items-center justify-center">
                <canvas id="pelanggarChart" class="w-28 h-28" style="max-height:120px;"></canvas>
                <p class="mt-2 font-semibold">Pelanggar: <span id="pelanggar-count">0</span></p>
            </div>
            <div class="flex flex-col items-center justify-center">
                <canvas id="totalChart" class="w-28 h-28" style="max-height:120px;"></canvas>
                <p class="mt-2 font-semibold">Total Kendaraan: <span id="total-count">0</span></p>
            </div>
        </div>
    </div>

    <!-- =============================== -->
    <!-- DAILY CHART -->
    <!-- =============================== -->
    <div class="bg-white shadow rounded-xl p-6">
        <h2 class="font-semibold text-gray-700 mb-4">Total Volume Kendaraan Hari Ini</h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 place-items-center">
            <div class="flex flex-col items-center justify-center">
                <canvas id="motorHarianChart" class="w-28 h-32" style="max-height:130px;"></canvas>
                <p class="mt-2 font-semibold">Motor</p>
            </div>
            <div class="flex flex-col items-center justify-center">
                <canvas id="mobilHarianChart" class="w-28 h-32" style="max-height:130px;"></canvas>
                <p class="mt-2 font-semibold">Mobil</p>
            </div>
            <div class="flex flex-col items-center justify-center">
                <canvas id="pelanggarHarianChart" class="w-28 h-32" style="max-height:130px;"></canvas>
                <p class="mt-2 font-semibold">Pelanggar</p>
            </div>
            <div class="flex flex-col items-center justify-center">
                <canvas id="totalHarianChart" class="w-28 h-32" style="max-height:130px;"></canvas>
                <p class="mt-2 font-semibold">Total Kendaraan</p>
            </div>
        </div>
    </div>

</div>

<!-- =============================== -->
<!-- CHART.JS -->
<!-- =============================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
Chart.defaults.maintainAspectRatio = false;
Chart.defaults.responsive = true;

// daftar chart
const chartList = [
    { id: 'motorChart', color: '#2563eb' },
    { id: 'mobilChart', color: '#38bdf8' },
    { id: 'pelanggarChart', color: '#ef4444' },
    { id: 'totalChart', color: '#22c55e' },
    { id: 'motorHarianChart', color: '#2563eb' },
    { id: 'mobilHarianChart', color: '#38bdf8' },
    { id: 'pelanggarHarianChart', color: '#ef4444' },
    { id: 'totalHarianChart', color: '#22c55e' }
];

// inisialisasi
window.liveCharts = {};
chartList.forEach(cfg => {
    const ctx = document.getElementById(cfg.id);
    if (ctx) {
        window.liveCharts[cfg.id] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0, 100],
                    backgroundColor: [cfg.color, '#e5e7eb'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                animation: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });
    }
});

// update chart (throttled)
let lastUpdate = 0;
function updateCharts(data) {
    const now = Date.now();
    if (now - lastUpdate < 1000) return;
    lastUpdate = now;

    for (const key of ['motor', 'mobil', 'pelanggar', 'total']) {
        const chartId = key + 'Chart';
        const chart = window.liveCharts[chartId];

        if (chart) {
            const value = data[key] || 0;
            chart.data.datasets[0].data = [value, 100 - (value % 100)];
            chart.update('none');
        }

        const span = document.getElementById(`${key}-count`);
        if (span) span.textContent = data[key] || 0;
    }
}

// update status stream
function updateLivestreamStatus(data) {
    const el = document.getElementById("livestream-status");
    if (!el) return;

    if (data.stream_active) {
        el.textContent = "✅ Live Streaming Aktif";
        el.classList.replace("text-red-600", "text-green-600");
    } else {
        el.textContent = "⚠ LIVE STREAMING SEDANG TIDAK TERSEDIA";
        el.classList.replace("text-green-600", "text-red-600");
    }
}
</script>

<!-- =============================== -->
<!-- GLOBAL REALTIME JS -->
<!-- =============================== -->
<script src="{% static 'js/realtime.js' %}"></script>

{% endblock %}
