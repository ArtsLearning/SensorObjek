{% extends "base.html" %}
{% load static %}

{% block title %}LiveStream - Traffic Eye{% endblock %}
{% block content %}

<!-- ================= NAVBAR ================= -->
<nav class="livestream-navbar">
  <div class="livestream-navbar-container">
    <button class="livestream-back-btn" onclick="window.location.href='/'">&#8592;</button>
    <h1 class="livestream-navbar-title">HALAMAN LIVESTREAM</h1>
    <div class="livestream-navbar-logo">
      <img src="{% static 'home/images/logo.png' %}" alt="Traffic Eye Logo" />
      <span>TRAFFIC<br />EYE</span>
    </div>
  </div>
</nav>

<!-- ================= VIDEO ================= -->
<section class="livestream-section">
  <div class="video-container">
    <div class="video-wrapper">
      <img id="live-cctv"
           src="http://127.0.0.1:5000/video_feed"
           class="video-iframe"
           alt="Menghubungkan ke CCTV..." />
      <button class="fullscreen-btn" onclick="toggleFullscreen()">â›¶</button>
    </div>
    <div class="video-overlay">
      <span id="livestream-status" class="text-red-600 font-semibold"></span>
    </div>
  </div>
</section>

<!-- ================= STAT ================= -->
<section class="stats-section">

  <!-- REALTIME -->
  <div class="stats-card">
    <h3>VOLUME KENDARAAN (REALTIME)</h3>
    <p class="timestamp">di update: <span id="last-update">-</span></p>

    <div class="chart-grid">
      <div class="chart"><canvas id="motorChart"></canvas><p>Motor: <span id="motor-count">0</span></p></div>
      <div class="chart"><canvas id="mobilChart"></canvas><p>Mobil: <span id="mobil-count">0</span></p></div>
      <div class="chart"><canvas id="pelanggarChart"></canvas><p>Pelanggar: <span id="pelanggar-count">0</span></p></div>
      <div class="chart"><canvas id="totalChart"></canvas><p>Total: <span id="total-count">0</span></p></div>
    </div>
  </div>

  <!-- HARIAN -->
  <div class="stats-card">
    <h3>TOTAL VOLUME KENDARAAN HARIAN</h3>
    <p class="timestamp">di update: <span id="harian-update">-</span></p>

    <div class="chart-grid">
      <div class="chart"><canvas id="motorHarianChart"></canvas><p>Motor: <span id="motorHarian-count">0</span></p></div>
      <div class="chart"><canvas id="mobilHarianChart"></canvas><p>Mobil: <span id="mobilHarian-count">0</span></p></div>
      <div class="chart"><canvas id="pelanggarHarianChart"></canvas><p>Pelanggar: <span id="pelanggarHarian-count">0</span></p></div>
      <div class="chart"><canvas id="totalHarianChart"></canvas><p>Total: <span id="totalHarian-count">0</span></p></div>
    </div>
  </div>

  <a href="{% url 'user_pelanggaran' %}" class="btn-realtime">Lihat Hasil Deteksi</a>
</section>

{% include "home/components/footer.html" %}

<!-- ================= CHART ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const MAX = 100;
const clamp = v => Math.max(0, Math.min(v, MAX));

function donut(id, color) {
  return new Chart(document.getElementById(id), {
    type: "doughnut",
    data: { datasets: [{ data: [0, MAX], backgroundColor: [color, "#e5e7eb"], borderWidth: 0 }] },
    options: { cutout: "75%", plugins: { legend: { display: false }, tooltip: { enabled: false } } }
  });
}

/* INIT */
window.realtimeCharts = {
  motorChart: donut("motorChart", "#2563eb"),
  mobilChart: donut("mobilChart", "#38bdf8"),
  pelanggarChart: donut("pelanggarChart", "#ef4444"),
  totalChart: donut("totalChart", "#22c55e"),
};
window.dailyCharts = {
  motorHarianChart: donut("motorHarianChart", "#2563eb"),
  mobilHarianChart: donut("mobilHarianChart", "#38bdf8"),
  pelanggarHarianChart: donut("pelanggarHarianChart", "#ef4444"),
  totalHarianChart: donut("totalHarianChart", "#22c55e"),
};

/* DIPANGGIL realtime.js */
function updateCharts(data) {
  [["motor", "motorChart"], ["mobil", "mobilChart"], ["pelanggar", "pelanggarChart"], ["total", "totalChart"]]
    .forEach(([k, id]) => {
      const v = clamp(data[k]);
      realtimeCharts[id].data.datasets[0].data = [v, MAX - v];
      realtimeCharts[id].update();
    });
}

/* FETCH HARIAN */
async function fetchHarian() {
  try {
    const r = await fetch("/api/get-traffic-harian/");
    const d = await r.json();

    document.getElementById("harian-update").innerText = d.tanggal || "-";
    document.getElementById("motorHarian-count").innerText = d.motor;
    document.getElementById("mobilHarian-count").innerText = d.mobil;
    document.getElementById("pelanggarHarian-count").innerText = d.pelanggar;
    document.getElementById("totalHarian-count").innerText = d.total;

    [["motor", "motorHarianChart"], ["mobil", "mobilHarianChart"], ["pelanggar", "pelanggarHarianChart"], ["total", "totalHarianChart"]]
      .forEach(([k, id]) => {
        const v = clamp(d[k]);
        dailyCharts[id].data.datasets[0].data = [v, MAX - v];
        dailyCharts[id].update();
      });

  } catch (e) {
    console.warn("Harian error", e);
  }
}

document.addEventListener("DOMContentLoaded", fetchHarian);

/* FULLSCREEN */
function toggleFullscreen() {
  const v = document.getElementById("live-cctv");
  if (v.requestFullscreen) v.requestFullscreen();
}
</script>

<script src="{% static 'js/realtime.js' %}"></script>

<style>
.video-wrapper{position:relative;padding-bottom:56.25%;background:#000;border-radius:12px}
.video-iframe{position:absolute;width:100%;height:100%}
.fullscreen-btn{position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,.6);color:#fff;border:1px solid #fff;padding:8px 14px}
</style>

{% endblock %}
